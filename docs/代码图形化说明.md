**代码驱动图形化说明**

- **概述**: 本说明描述游戏如何将用户在代码编辑器中输入的 Python 代码实时解析为工厂布局并在 UI 中渲染。关键流程为：`CodeEditor` → `code_parser` → `Factory`（创建机器与连接）→ 游戏场景绘制。

**关键文件与位置**

- **代码编辑器（输入）**: `CodeEditor` — 负责接收用户输入并在每次变化时回调。参见 [pyfactory/ui.py](pyfactory/ui.py#L450-L720)（`CodeEditor` 类实现）。
- **实时回调（解析入口）**: `_on_code_change` — 在 UI 场景中接收 `CodeEditor` 的回调并启动解析与注入流程。参见 [pyfactory/main.py](pyfactory/main.py#L440-L520)（函数 `def _on_code_change(self, code: str)`）。
- **代码解析**: `CodeParser.parse` — 将简化的 Python 语句解析为机器列表与连接列表（变量赋值与 `.connect()` 语法）。参见 [pyfactory/code_parser.py](pyfactory/code_parser.py#L1-L220)（`CodeParser.parse` 与 `_parse_assignment/_parse_connection`）。
- **工厂与注入**: `Factory` 类 — 管理 `machines`、`connections` 和更新逻辑；注入时用 `create_machine()` 创建机器并 `factory.add_machine()`/`factory.connect()` 连接。参见 [pyfactory/game_engine.py](pyfactory/game_engine.py#L1-L120)（`class Factory`）与 [pyfactory/main.py](pyfactory/main.py#L468-L506)（注入示例）。
- **机器绘制与连线**:
  - `Machine.draw` / 各机器子类绘制：在 [pyfactory/machines.py](pyfactory/machines.py#L200-L360)（`Machine.draw` 及子类绘制）中实现机器外观与进度条。
  - `Connection.draw`：绘制连接线与传输中的物品（含发光与箭头），见 [pyfactory/machines.py](pyfactory/machines.py#L1-L120)（`Connection.draw`）。
- **图形对象**: `Shape.draw` — 负责具体图形（circle/square/triangle 等）的渲染与旋转，见 [pyfactory/shapes.py](pyfactory/shapes.py#L90-L140)。
- **编辑器错误显示**: `_on_code_change` 会将 `code_parser.parse` 返回的 `error` / `error_line` 赋给 `CodeEditor.error_line` 与 `CodeEditor.error_msg`，编辑器会高亮错误行（避免注入错误代码）。参见 [pyfactory/main.py](pyfactory/main.py#L440-L520) 和 [pyfactory/ui.py](pyfactory/ui.py#L450-L720)。
- **测试与离屏渲染**（辅助工具）: 我添加了 `pyfactory/realtime_test.py` 用于离屏解析、仿真与输出 PNG（示例：`render_factory_to_png`、`run_factory_simulation`）。参见 [pyfactory/realtime_test.py](pyfactory/realtime_test.py#L1-L320)。

**数据流（简洁版）**

1. 用户在 UI 的 `CodeEditor` 编辑代码（按键或粘贴）。
2. `CodeEditor` 在每次变更时调用传入的回调：`GameScene_._on_code_change(code)`。
3. `_on_code_change` 调用 `code_parser.parse(code)` 获得 `machines` 与 `connections` 列表或解析错误。
4. 若无错误：清空当前目标 `Factory`（沙盒或关卡工厂），用 `create_machine()` 创建机器并 `factory.add_machine()`，再按连接列表 `factory.connect()`。
5. 游戏主循环中场景的 `draw` 会遍历 `factory.connections` 与 `factory.machines` 并分别调用 `Connection.draw` 与 `Machine.draw`，最终在屏幕（或离屏 Surface）上呈现图形与传送效果。

**常见问题与扩展点**

- 错误高亮：解析失败时，`CodeEditor` 会显示错误行并阻止注入到工厂（避免运行时异常）。
- 绘制顺序：连线可能被机器遮挡；若需要让连线位于上层，可在绘制时先绘制机器再绘制连接（或反之，按视觉需求调整）。实现位置在 `main.py` 的 `draw` 中。
- 扩展语法：要支持更多语句（例如带参数的连接端口、命名端口、位置指定等），请修改 `code_parser.py` 中的解析器函数 `_parse_assignment` / `_parse_connection` 并相应调整 `main._on_code_change` 中的注入逻辑。
- 无窗口渲染：已有 `realtime_test.py` 提供离屏渲染示例，可用于单元测试或生成静态预览 PNG。

**如何快速定位并调试**

- 打开 `CodeEditor` 功能：查看 [pyfactory/ui.py](pyfactory/ui.py#L450-L720)。
- 修改实时回调：编辑 [pyfactory/main.py](pyfactory/main.py#L440-L520) 的 `_on_code_change`（例如在注入前打印解析结果以调试布局）。
- 检查渲染问题：查看 `machines.py` 与 `shapes.py` 的 `draw` 方法（链接见上），捕获异常可防止整个渲染中断（测试脚本中已示例）。

---

如果你需要，我可以：

- 将本说明加入代码注释或项目 README 中；
- 为 `code_parser` 添加更完整的语法样例与单元测试；
- 改造 `CodeEditor` 回调为按节流（debounce）触发以减少解析频率（对大型代码有帮助）。

文档已保存为： [docs/代码图形化说明.md](docs/%E4%BB%A3%E7%A0%81%E5%9B%BE%E5%BD%A2%E5%8C%96%E8%AF%B4%E6%98%8E.md)
